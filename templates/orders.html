{% extends "base.html" %}
{% block title %}–ó–∞–∫–∞–∑—ã{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-8">
  <h1 class="text-3xl font-bold mb-6">üì¶ –ó–∞–∫–∞–∑—ã ({{ orders|length }})</h1>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="flex gap-4 mb-4 flex-wrap">
    {% set statuses = {
      'PICKING': '–£–ø–∞–∫–æ–≤–∫–∞',
      'READY': '–ü–µ—Ä–µ–¥–∞—á–∞',
      'DELIVERY': '–ü–µ—Ä–µ–¥–∞–Ω—ã –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É',
      'CANCELLED': '–û—Ç–º–µ–Ω–µ–Ω—ã –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ',
      'PREORDER': '–ü—Ä–µ–¥–∑–∞–∫–∞–∑',
      'ARCHIVE': '–ê—Ä—Ö–∏–≤'
    } %}
    {% for key, label in statuses.items() %}
      <a href="{{ url_for('orders_page', state=key) }}"
         class="px-4 py-2 rounded-lg text-sm font-medium border transition
                {% if selected_state == key %}
                  bg-red-600 text-white border-red-600
                {% else %}
                  bg-gray-100 text-gray-800 hover:bg-gray-200 border-gray-300
                {% endif %}">
        {{ label }}
        {% if status_counts[key] %}
          <span class="ml-1 text-xs font-semibold">
            ({{ status_counts[key] }})
          </span>
        {% endif %}
      </a>
    {% endfor %}
  </div>

  <!-- –ü–æ–∏—Å–∫ -->
  <form method="get" class="flex gap-4 mb-6 flex-wrap items-end">
    <input type="hidden" name="state" value="{{ selected_state }}">
    <div>
      <label for="order_code" class="text-sm block mb-1">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</label>
      <input type="text" id="order_code" name="order_code" value="{{ request.args.get('order_code', '') }}"
             class="border rounded-lg px-3 py-2 text-sm w-48">
    </div>
    <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
      üîç –ü–æ–∏—Å–∫
    </button>
  </form>

  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <div class="overflow-x-auto bg-white shadow rounded-lg border">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 text-left">
        <tr>
          <th class="py-2 px-4">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</th>
          <th class="py-2 px-4">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</th>
          <th class="py-2 px-4">–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∫—É—Ä—å–µ—Ä—É</th>
          {% if selected_state == "READY" %}
            <th class="py-2 px-4">–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr class="border-t hover:bg-gray-50 cursor-pointer"
            data-order='{{ order.full | tojson | safe }}'
            onclick="openModalFromElement(this)">
          <td class="py-2 px-4 text-blue-600 underline">{{ order.code }}</td>
          <td class="py-2 px-4">{{ order.delivery_type }}</td>
          <td class="py-2 px-4">{{ order.courier_date | datetimeformat }}</td>
      {% if selected_state == "READY" %}
        <td class="py-2 px-4">
          <a href="{{ url_for('download_waybill_route', order_code=order.code) }}"
            class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded flex items-center justify-center">
            üìÑ –°–∫–∞—á–∞—Ç—å –ù–∞–∫–ª–∞–¥–Ω—É—é
          </a>
        </td>
      {% endif %}



        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="py-4 px-4 text-center text-gray-400">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Waybill -->
<script>
  async function generateWaybill(orderId) {
    const confirmed = confirm("–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é?");
    if (!confirmed) return;

    const response = await fetch("/api/generate_waybill", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order_id: orderId, number_of_space: 1 })
    });

    const result = await response.json();
    alert(result.success ? "–ù–∞–∫–ª–∞–¥–Ω–∞—è —Å–æ–∑–¥–∞–Ω–∞!" : "–û—à–∏–±–∫–∞: " + result.error);
    if (result.success) location.reload();
  }
console.log("–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é –¥–ª—è –∑–∞–∫–∞–∑–∞:", orderId);

</script>
{% endblock %}
